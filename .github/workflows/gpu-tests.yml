name: GPU Tests (Optional)

on:
  workflow_dispatch:  # Manual trigger only
  schedule:
    # Run weekly on Sunday at 2am UTC (optional, can be removed)
    - cron: '0 2 * * 0'

jobs:
  gpu-test:
    runs-on: [self-hosted, gpu]  # Requires GPU runner
    # Alternative: use GitHub's beta GPU runners when available
    # runs-on: ubuntu-latest-gpu
    
    strategy:
      fail-fast: false
      matrix:
        framework: [cupy, torch-gpu]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check CUDA availability
        run: |
          nvidia-smi || echo "No NVIDIA GPU detected"
          nvcc --version || echo "No CUDA compiler detected"

      - name: Install base dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Install CuPy
        if: matrix.framework == 'cupy'
        run: |
          pip install cupy-cuda12x  # Adjust CUDA version as needed

      - name: Install PyTorch (GPU)
        if: matrix.framework == 'torch-gpu'
        run: |
          pip install torch --index-url https://download.pytorch.org/whl/cu121

      - name: Run GPU-specific tests
        run: |
          # Run only tests marked with @pytest.mark.gpu
          pytest -v -m "gpu" --cov=arraybridge --cov-report=term-missing
        continue-on-error: true  # Don't fail the workflow if GPU tests fail

      - name: Run framework-specific tests
        run: |
          # Run tests for the specific framework
          pytest -v -m "${{ matrix.framework }}" --cov=arraybridge --cov-report=term-missing
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: gpu-test-results-${{ matrix.framework }}
          path: |
            htmlcov/
            .coverage

